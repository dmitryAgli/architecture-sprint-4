# Планирование по покрытию сервисов логами
| Сервис | Метод | Параметры | Уровень логирования |
| --- | --- | --- | --- |
| Shop API | [Запрос] Инициация заказа | дата и время, идентификатор пользователя, идентификатор заказа | INFO |
| Shop API | [Ответ] Инициация нового заказа | дата и время, статус ответа, идентификатор заказа, статус заказа | INFO |
| Shop API | [Запрос] Загрузка файла с 3D-моделью | дата и время, идентификатор пользователя, идентификатор заказа | INFO |
| Shop API | [Ответ] Загрузка файла с 3D-моделью | дата и время, статус ответа, идентификатор заказа, статус заказа | INFO |
| Shop API | [Запрос] Создание заказа | дата и время, идентификатор пользователя, идентификатор заказа | INFO |
| Shop API | [Ответ] Создание заказа | дата и время, статус ответа, идентификатор заказа, статус заказа | INFO |
| MES API | [Публикация_сообщения] Система посчитала стоимость заказа | дата и время, идентификатор заказа | INFO |
| CRM API | [Запрос] Подтверждение заказа | дата и время, идентификатор продавца, идентификатор заказа | INFO |
| CRM API | [Ответ] Подтверждение заказа | дата и время, статус ответа, идентификатор заказа, статус заказа | INFO |
| MES API | [Запрос] Взять заказ в работу | дата и время, идентификатор оператора, идентификатор заказа | INFO |
| MES API | [Ответ] Взять заказ в работу | дата и время, статус ответа, идентификатор заказа, статус заказа | INFO |
| MES API | [Запрос] Подтвердить выполнение заказа | дата и время, идентификатор оператора, идентификатор заказа | INFO |
| MES API | [Ответ] Подтвердить выполнение заказа | дата и время, статус ответа, идентификатор заказа, статус заказа | INFO |
| MES API | [Запрос] Подготовить заказ к отправке | дата и время, идентификатор оператора, идентификатор заказа | INFO |
| MES API | [Ответ] Подготовить заказ к отправке | дата и время, статус ответа, идентификатор заказа, статус заказа | INFO |
| MES API | [Запрос] Подтвердить отправку заказа | дата и время, идентификатор оператора, идентификатор заказа | INFO |
| MES API | [Ответ] Подтвердить отправке заказа | дата и время, статус ответа, идентификатор заказа, статус заказа | INFO |
| CRM API | [Запрос] Завершение заказа | дата и время, идентификатор продавца, идентификатор заказа | INFO |
| CRM API | [Ответ] Завершение заказа | дата и время, статус ответа, идентификатор заказа, статус заказа | INFO |

# Мотивация журналирования логов
- **Устранение неполадок и отладка**: журналирование логов помогает разработчикам точно определить место и причину проблем
- **Безопасность**: журналы регистрируют действия пользователей, активность системы и потенциальные угрозы, помогая выявлять подозрительное поведение и реагировать на инциденты безопасности 
- **Оптимизация производительности**: анализируя данные журналов, разработчики могут выявлять узкие места, неэффективность и ресурсоемкие операции, что позволяет им оптимизировать производительность системы и улучшить использование ресурсов

## Влияние внедрения инструментов логирования на метрики
| Метрика                 | Описание                                                                                                   | Тип                |
| ----------------------- | ---------------------------------------------------------------------------------------------------------- | ------------------ |
| RTO                     | Промежуток времени с момента возникновения сбоя, в течении которого необходимо восстановить работу системы | Производительность |
| Доступность             | Процент времени в течении года, когда система доступна и выполняет заявленную функциональность             | Производительность |
| Количество открытых заявок в HelpDesk | Количество обращений в техническую поддержку                                                 | Бизнес метрики     |
| Response time (latency) | Время ответа                                                                                               | Производительность |
| Number of orders        | Количество новых заказов                                                                                   | Бизнес метрики     |
| Number of registered    | Количество новых пользователей                                                                             | Бизнес метрики     |

## Порядок покрытия сервисов логами
- 1 приоритет: Shop API - влияние на количество новых заказов и лояльность покупателей  
- 2 приоритет: MES API - влияние на количество новых заказов от партеров сервиса
- 3 приоритет: CRM API - вляние на скорость обработки новых заказов

# Предлагаемое решение
[Схема решения](./model/jewerly_c4_model.drawio)

## Политика безопасности при работе с логами
- Аутентификация: для обеспечения предотовращения доступа к логам посторонних лиц. 
- Авторизация: для обеспечения контроля доступа к защищаемым элементам системы применяется система разграничения доступа, основанная на ролях.
- Маскирование конфиденциальных данных: обеспечение защиты персональных данных и конфиденциальных сведений при выполнении запросов должна быть реализована функциональность маскирования запросов.

## Политика хранения логов
**Сегментация индексов**
- Shop API - выделенные индексы  
- MES API - выделенные индексы
- CRM API - выделенные индексы

**Квотирование ресурсов**
- Максимальный размер индекса: 10 ГБ.
- При достижении лимита активируется ролловер.

**Жизненный цикл данных**
- Индексы старше 14 дней автоматически удаляются

# Мероприятия направленные на развитие системы сбора логов в систему анализа логов

Для реализации решения позволяющего использовать ELK Stack для реализации системы анализа логов и оповещения, требуется объеденить сервис Elasticsearch с двумя типами компонентов: типами правил и оповещениями.
Требования к решению:
1) Elasticsearch периодически опрашивается, и данные передаются в компонент тип правила, который определяет, когда найдено совпадение. 
2) Когда происходит совпадение, событие передается одному или нескольким компонентам оповещения, которые предпринимают действия на основе совпадения.
3) Есть возможность настройки политик, каждое из которых определяет запрос, тип правила и набор оповещений.

Требования к типам правил и событий:
- [frequency]: совпадение, где есть X событий в Y время
- [spike]: сопоставить, когда скорость событий увеличивается или уменьшается
- [flatline]: сопаставить, когда за Y время произошло менее X событий
- [blacklist/whitelist]: сопоставить, когда определенное поле соответствует черному/белому списку
- [any]: соответствие любому событию, соответствующему заданному фильтру
- [change]: сопоставить, когда поле имеет два разных значения в течение некоторого времени

Требования к каналам оповещения:
- [email]: отправка почты
- [telegram]: отправка в Telegram
- [sms]: отправка в sms